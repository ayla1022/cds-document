---
title: PHP连接示例
date: 2021-12-06 17:00:00
permalink: /pages/746014/
article: true
---


在 PHP 里，有驱动可用于连接操作 MongoDB 数据库：mongodb（[官网文档](http://php.net/manual/en/set.mongodb.php)），MongoDB 官方推荐 mongodb 驱动，但需要 PHP 5.4 以上版本。

下面用上述驱动演示连接云数据库 MongoDB 并进行读写。

#### 使用 mongodb 驱动

mongodb 安装方法参考 [官方安装步骤](http://php.net/manual/zh/mongodb.installation.php)。

示例代码：

```
<?php
// 拼接连接 URI
$uri = 'mongodb://username:password@10.xx.xx.xx:27017/admin';
$manager = new MongoDB\Driver\Manager($uri);

// 准备写入数据
$document1 = [
    'username' => 'Tom',
    'age'      => 25,
    'email'    => 'tom@xx.com'
];

// 驱动预处理数据，这里可以看到 MongoDB 的 _id 是驱动生成的
$bulk = new MongoDB\Driver\BulkWrite;
$_id1 = $bulk->insert($document1);

$result = $manager->executeBulkWrite('tsdb.table1', $bulk);

// 或者根据实际需要使用下面的代码确保数据写入到大多数节点
// $writeConcern = new MongoDB\Driver\WriteConcern(MongoDB\Driver\WriteConcern::MAJORITY, 1000);
// $result = $manager->executeBulkWrite('testdb.testcollection', $bulk, $writeConcern);

// 查询
$filter = ['_id' => $_id1];
$query = new MongoDB\Driver\Query($filter);
$rows = $manager->executeQuery('tsdb.table1', $query); // 也可选择优先从从库读
foreach($rows as $r){
   print_r($r);
}
```

输出：

```
stdClass Object
(
    [_id] => MongoDB\BSON\ObjectID Object
        (
            [oid] => 582c001618c90a16363abc31
        )

    [username] => Tom
    [age] => 25
    [email] => tom@xx.com
)
```

#### 推荐使用 PHPLIB 库（基于 mongodb 驱动封装）

使用 mongodb 驱动推荐搭配 [PHPLIB](http://php.net/manual/zh/mongodb.tutorial.library.php) 使用，详情参见 [相关文档](http://mongodb.github.io/mongo-php-library/tutorial/crud/)。

PHPLIB 的安装方法参考 [官方安装步骤](http://mongodb.github.io/mongo-php-library/getting-started/)，请注意 PHPLIB 依赖与 mongodb 驱动。

示例代码：

```
<?php
require_once __DIR__ . "/vendor/autoload.php";

// 初始化
$mongoClient = new MongoDB\Client('mongodb://username:password@10.xx.xx.xx:27017/admin');

// 使用 demo 库下的 users 集合
$collection = $mongoClient->demo->users;

// 写入一条数据
$insertOneResult = $collection->insertOne(['name' => 'Tom']);

printf("Inserted %d document(s)\n", $insertOneResult->getInsertedCount());
var_dump($insertOneResult->getInsertedId());

// 查询数据
$document = $collection->findOne(['name' => 'Tom']);

var_dump($document);
```

输出：

```
Inserted 1 document(s)
object(MongoDB\BSON\ObjectID)#11 (1) {
  ["oid"]=>
  string(24) "57e3bf20bf605714a53e69c1"
}
object(MongoDB\Model\BSONDocument)#16 (1) {
  ["storage":"ArrayObject":private]=>
  array(2) {
    ["_id"]=>
    object(MongoDB\BSON\ObjectID)#14 (1) {
      ["oid"]=>
      string(24) "57e3bf20bf605714a53e69c1"
    }
    ["name"]=>
    string(3) "Tom"
  }
}
```

