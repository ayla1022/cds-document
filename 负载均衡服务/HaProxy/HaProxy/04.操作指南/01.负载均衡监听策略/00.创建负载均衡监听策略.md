---
title: 创建负载均衡监听策略   
date: 2021-11-12 10:17:01
permalink: /pages/1233015/
article: true
---


## 前置条件

您已成功创建负载均衡 HaProxy 实例，实例状态为运行中，创建实例步骤详情参见 [创建负载均衡实例](../../04.操作指南/00.负载均衡实例/00.创建负载均衡实例.md)。

## 控制台创建

### 操作步骤

1. 进入 [负载均衡控制台](https://console.capitalonline.net/loadbalancers)，在实例列表中选择需要添加策略的实例，在“操作”列选择 **策略配置** 或进入到实例管理页面选择 **策略配置** 。

2. 在策略配置页面，点击右上角 **添加策略**。

   ![添加策略](../../pic/new-policy-rule.png)

3. 在监听策略创建页，配置 TCP 或 HTTP/HTTPS 策略。

   #### 策略基本配置

   <table width="95%" border="1" cellpadding="2" cellspacing="1">
   	<thead>
           <tr>
               <th align="left" width="15%">配置项</th>
               <th align="left" width="70%">说明</th>
           </tr>
   	</thead>
       <tbody>
           <tr>
               <td>策略配置名称</td>
               <td>监听策略的名称，最多输入 15 个字符，由英文、数字及-_组成，并且以英文开头</td>
           </tr>
           <tr>
               <td>协议类型</td>
               <td>监听策略的协议类型，支持四层（TCP）、七层（HTTP/HTTPS）</td>
           </tr>
           <tr>
               <td>代理端口</td>
               <td>用来接收请求并向后端服务器转发请求的端口，端口输入范围为 1-65535，22、1080、9100 和 9101 端口已被使用</td>
           </tr>
            <tr>
               <td>调度算法</td>
               <td>支持选择策略的调度算法：</br>
                   <ul>
                       <li><b>roundrobin</b>：简单轮询，每个服务器根据权重轮流使用。此算法是动态的，对于实例启动慢的服务器权重会在运行中调整。</li>
                       <li><b>leastconn</b>：连接数最少的服务器优先接收连接。建议用于长会话服务。</li>
                       <li><b>static-rr</b>：每个服务器根据权重轮流使用。此算法是静态的，意味着运行时修改权限是无效的。</li>
                       <li><b>source</b>：对请求源IP地址进行哈希，用可用服务器的权重总数除以哈希值，根据结果进行分配。</li>
                       <li><b>url</b>：表示根据请求的URI左端（问号之前）进行哈希，用可用服务器的权重总数除以哈希值，根据结果进行分配。</li>
           		</ul>
           	</td>
           </tr>
   		<tr>
               <td>最大连接数</td>
               <td>支持自定义，默认值为剩余可用连接数数量，所有策略最大连接数总和不能超过当前规格最大连接数，超过当前规格最大连接数后，会出现丢失的情况。</td>
           </tr>
   		<tr>
               <td>访问控制</td>
               <td>访问控制开关，允许任何IP访问负载均衡监听器，开启访问控制开关，只允许白名单列表中的IP访问负载均衡。</td>
           </tr>
   	</tbody>
   </table>

   #### 超时时间设置

   <table width="95%" border="1" cellpadding="2" cellspacing="1">
   	<thead>
           <tr>
               <th align="left" width="15%">配置项</th>
               <th align="left" width="70%">说明</th>
           </tr>
   	</thead>
       <tbody>
           <tr>
               <td>连接超时时间</td>
               <td>设置请求连接超时的时间</td>
           </tr>
           <tr>
               <td>客户端超时</td>
               <td>设置客户端连接超时的时间</td>
           </tr>
           <tr>
               <td>服务端超时</td>
               <td>设置服务器端连接超时的时间</td>
           </tr>
   	</tbody>
   </table>

   #### TCP基本配置

   | 配置项       | 说明                                                         |
   | ------------ | ------------------------------------------------------------ |
   | 获取源IP     | 单层 HaProxy 代理, 只需要开启获取源IP即可，详情参见 [配置获取源IP](../../06.最佳实践/00.配置获取源IP与源IP多层透传.md) |
   | 源IP多层透传 | 多层 HaProxy 代理, 首层代理(首层代理为客户直连代理)开启"获取源IP", 非首层代理需要同时开启"获取源IP"和"源IP多层穿透"，详情参见 [源IP多层透传](../../06.最佳实践/00.配置获取源IP与源IP多层透传.md) |

   #### HTTP和HTTPS基本配置

   | 配置项       | 说明                                                         |
   | ------------ | ------------------------------------------------------------ |
   | HTTP证书     | 支持 HTTPS，开启证书验证功能，绑定证书后所有应用请求通过证书验证后在进行连接。HTTP添加证书详情参见 [配置证书](./../../04.操作指南/02.证书管理/00.配置证书.md) |
   | Cookie头     | 启用后端服务器 cookie 的持久连接功能，开启后需输入后端服务器设定cookie头名称和参数<br />**输入内容示例**：<br />示例1：JSESSIONID prefix<br />示例2：SRV insert indirect nocache |
   | Keep-Alive   | Keep-Alive功能使客户端到服务器端的连接持续有效，当出现对服务器的后继请求时，Keep-Alive功能避免了建立或者重新建立连接 |
   | HTTP 2.0     | HaProxy支持HTTP2.0，需先绑定证书才能开启                     |
   | Gzip数据压缩 | 开启后会对数据进行压缩，节省流量                             |
   | 获取源IP     | HTTP协议默认开启获取源IP，详情参见 [配置获取源IP](../../06.最佳实践/00.配置获取源IP与源IP多层透传.md) |

   #### HTTP/HTTPS Option设置

   <table width="95%" border="1" cellpadding="2" cellspacing="1">
   	<thead>
           <tr>
               <th align="left" width="15%">配置项</th>
               <th align="left" width="70%">说明</th>
           </tr>
   	</thead>
       <tbody>
           <tr>
               <td>httplog</td>
               <td>启用记录 HTTP 请求、会话状态和计时器的功能</td>
           </tr>
           <tr>
               <td>forwardfor</td>
               <td>允许在发往服务器的请求首部中插入“X-Forwarded-For”首部</td>
           </tr>
           <tr>
               <td>abortonclose</td>
               <td>当服务器负载过高时，将自动关闭队列中处理时间较长的连接请求</td>
           </tr>
           <tr>
               <td>httpchk</td>
               <td>开启健康检查并设置心跳检测的 URL，允许用 HTTP 协议检查后端服务器的健康状态，开启后需设置健康检查的URL</br><b>输入内容示例：</b></br>GET /index.php</td>
           </tr>
   	</tbody>
   </table>

   #### HTTP/HTTPS 附加HTTP头字段设置

   <table width="95%" border="1" cellpadding="2" cellspacing="1">
   	<thead>
           <tr>
               <th align="left" width="15%">配置项</th>
               <th align="left" width="70%">说明</th>
           </tr>
   	</thead>
       <tbody>
           <tr>
               <td>http_x_forwarded_proto</td>
               <td>通过 http_x_forwarded_proto 重定向（支持重定向到HTTPS或任何后端服务器）</td>
           </tr>
           <tr>
               <td>X-Forwarded-Proto</td>
               <td>通过 X-Forwarded-Proto 头字段获取负载均衡的监听协议</td>
           </tr>
           <tr>
               <td>X-Forwarded-Port</td>
               <td>通过 X-Forwarded-Port 头字段获取负载均衡实例的监听端口</td>
           </tr>
           <tr>
               <td>X-Forwarded-Client-srcport</td>
               <td>通过 X-Forwarded-Client-srcport 头字段获取访问负载均衡实例客户端的端口</td>
           </tr>
   	</tbody>
   </table>

   #### 后端服务器设置

   支持添加、修改，删除转发的后端服务器及配置信息，详情参见 [配置负载均衡监听策略后端机器](../../04.操作指南/01.负载均衡监听策略/02.配置负载均衡监听策略后端机器.md)。

4. 确认配置无误后，点击 **确认** 即可返回策略列表。

   ![策略列表](../../pic/new-policy-rule1.png)


## API创建

通过 API 创建负载均衡监听策略，详情参见 [创建负载均衡实例监听策略](../../09.API文档/03.监听策略相关接口/01.修改监听策略.md)。
