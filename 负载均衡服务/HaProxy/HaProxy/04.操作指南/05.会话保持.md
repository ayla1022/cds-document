---
title: 会话保持    
date: 2021-11-22 16:25:01
permalink: /pages/1233025/
article: true
---


会话保持是负载均衡器设备的一种机制，用于识别客户端与服务器之间交互过程的关连性，在进行负载均衡的同时还保证一系列相关连的访问请求会保持分配到同一台服务器上。默认情况下，负载均衡会将每个请求分别路由到不同后端服务器实例负载。但是，您可以使用会话保持功能使特定用户的请求被路由到同一台后端服务器实例上，以较典型的 HTTP 应用为例，在大多数电子商务的应用系统或者需要进行用户身份认证的在线系统中，一个客户与服务器经常经过好几次的交互过程才能完成一笔交易或者是一个请求的完成。


## 七层会话保持

七层协议（HTTP/HTTPS）是基于 Cookie 插入的方式实现会话保持功能（由负载均衡器向客户端植入 Cookie），会话保持支持设置过期时间，通过以下两个参数设置
- maxidle: 单位: 秒，当超过保持时间，连接内无新的请求，将会自动断开会话保持, 值为0表示会话没有空闲超时，即会话在最大生命周期一直有效。
- maxlife: 单位: 秒，设置会话的保持的最大时间，超过该时间则会话保持将结束, 且要求maxlife 大于maxidle, 值为0表示会话会一直保持，一直有效。

>**举例**:
>cdsslb_7a0408db insert  nocache indirect  maxidle 20s maxlife 60s




## 配置会话保持

1. 登录 [负载均衡控制台](https://console.capitalonline.net/loadbalancers)，单击需要配置会话保持的负载均衡实例 ID，进入负载均衡详情页。
2. 选择 **策略配置** 标签页。
3. 单击需要配置会话保持的负载均衡策略后单击 **配置**。
4. 选择 [Cookie头](./01.负载均衡监听策略/00.创建负载均衡监听策略.md#HTTP和HTTPS基本配置) 选项，单击按钮开启，输入 Cookie 的键名称，在页面底部单击 **确定**。
   


## 调度算法和会话保持的关系
场景: HTTP 业务
假设对负载均衡实例创建的策略开启了轮询（roundrobin）调度算法，同时也开启了会话保持功能，客户端通过负载均衡分发流量到云服务器是按照调度算法进行调度还是按照会话保持?

答：调度算法优先级是低于会话保持（cookie），因此当一个连接已经保持了会话，调度算法对该连接就无效。只有新的连接请求或者长连接已经失效时，才会使用调度算法进行调度。



## 长链接和会话保持的关系

场景: HTTP 业务
假设对负载均衡实例的策略开启了[连接保持（keep-alive）](./01.负载均衡监听策略/00.创建负载均衡监听策略.md#HTTP和HTTPS基本配置)选项，此时不开启会话保持，通过负载均衡，访问到云服务器，下一次访问还能访问同一台云服务器吗？

答：可以

首先连接保持功能（keep-alive）是客户端和服务器到负载均衡直接的长链接，它处理所有请求和响应报文，请求完后负载均衡两端的连接都处于空闲状态，因为和两端保持了连接，能够以较快方式重用会话，建议所有的策略都开启连接保持功能。因此对一个长链接来说是能够访问到相同云服务器，对于新建连接仍按照调度算法访问云服务器。
