---
title: 修改监听策略   
date: 2022-01-07 18:45:00
permalink: /pages/1233040/
article: true
---


## 1.接口描述

**Action**： ModifyLoadBalancerStrategys

**描述**： 修改（删除、修改、添加）Ha实例的当前监听的策略配置列表

**请求地址**： cdsapi.capitalonline.net/lb

**请求方法**： POST

## 2.请求参数
| 参数名        | 必选 | 类型                                       | 说明                  |
| :------------ | :--- | :----------------------------------------- | --------------------- |
| InstanceUuid  | 是   | string                                     | 要修改的实例编号      |
| HttpListeners | 是   | list of [HttpListeners](#httplistenersobj) | http 监听策略配置列表 |
| TcpListeners  | 否   | list of [TcpListeners](#tcplistenersobj)   | tcp 的监听策略列表    |

### HttpListenersObj

| 参数名             | 必选 | 类型                                                   | 说明                                                         |
| :----------------- | :--- | :----------------------------------------------------- | ------------------------------------------------------------ |
| ServerTimeoutUnit  | 是   | string                                                 | 设置服务端超时时间单位 【"ms","s"】                          |
| ServerTimeout      | 是   | string                                                 | 设置服务端超时时间                                           |
| StickySession      | 是   | string                                                 | 是否开启长连接（Keep Alive）  【"on","off"】                 |
| AclWhiteList       | 否   | list                                                   | 设置白名单 例如【"129.12.12.1"，"192.168.1.1/20"】           |
| CertificateIds     | 否   | list of [CertificateIdsObj](#certificateidsobj)        | http 监听可以绑定证书，不绑定传空列表                        |
| ListenerMode       | 是   | string                                                 | 监听模式                                                     |
| MaxConn            | 是   | int                                                    | 代理端的最大连接数                                           |
| ConnectTimeoutUnit | 是   | string                                                 | 设置请求连接超时的时间单位【"ms","s"】                       |
| Scheduler          | 是   | string                                                 | 调度算法【"roundrobin", "leastconn", "static-rr", "source"】 |
| SessionPersistence | 否   | object of [SessionPersistence](#sessionpersistenceobj) | 设置会话保持功能                                             |
| BackendServer      | 是   | list of [BackendServer](#backendserverobj)             | 后端服务器配置                                               |
| ConnectTimeout     | 是   | int                                                    | 设置请求连接超时时间                                         |
| ClientTimeout      | 是   | int                                                    | 设置客户端连接超时的时间                                     |
| ListenerName       | 是   | int                                                    | 监听策略的名称。<br>字符长度为1~15,以字母开头，以字母或数字结尾,由小写字母、数字或下划线组成, 名字要求唯一。 |
| ClientTimeoutUnit  | 是   | int                                                    | 设置客户端连接超时的时间单位【"ms","s"】                     |
| ListenerPort       | 是   | int                                                    | 策略监听端口。<br>取值范围1-65535，其中22、1080、9100、9101端口不在取值范围已被禁用。 |

### TcpListenersObj

| 参数名             | 必选 | 类型                                       | 说明                                                         |
| :----------------- | :--- | :----------------------------------------- | ------------------------------------------------------------ |
| ServerTimeoutUnit  | 是   | string                                     | 设置服务端超时时间单位 【"ms","s"】                          |
| AclWhiteList       | 否   | list                                       | 设置白名单 例如【"129.12.12.1"，"192.168.1.1/20"】           |
| ListenerMode       | 是   | string                                     | 监听模式                                                     |
| ListenerName       | 是   | int                                        | 监听策略的名称。<br>字符长度为1~15,以字母开头，以字母或数字结尾,由小写字母、数字或下划线组成, 名字要求唯一。 |
| Scheduler          | 是   | string                                     | 调度算法【"roundrobin", "leastconn", "static-rr", "source"】 |
| MaxConn            | 是   | int                                        | 代理端的最大连接数                                           |
| ClientTimeoutUnit  | 是   | int                                        | 设置客户端连接超时的时间单位【"ms","s"】                     |
| ListenerPort       | 是   | int                                        | 策略监听端口。<br>取值范围1-65535，其中22、1080、9100、9101端口不在取值范围已被禁用。 |
| ServerTimeoutUnit  | 是   | string                                     | 设置服务端超时时间单位 【"ms","s"】                          |
| ConnectTimeoutUnit | 是   | string                                     | 设置请求连接超时的时间单位【"ms","s"】                       |
| BackendServer      | 是   | list of [BackendServer](#backendserverobj) | 后端服务器配置                                               |
| ConnectTimeout     | 是   | int                                        | 设置请求连接超时时间                                         |
| ClientTimeout      | 是   | int                                        | 设置客户端连接超时的时间                                     |
| EnableSourceIp     | 否   | string                                     | 设置获取源IP。取值范围【"on","off"】，默认为off              |
| EnableRepeaterMode | 否   | string                                     | 设置当前Haproxy为中继默认且支持源IP透传。取值范围 【"on","off"】，默认为off，注意：如果设置了EnableRepeaterMode为on，则EnableSourceIp参数也必须为on |

### CertificateIdsObj

| 参数名          | 必选 | 类型   | 说明     |
| :-------------- | :--- | :----- | -------- |
| CertificateId   | 否   | string | 证书编号 |
| CertificateName | 否   | string | 证书名称 |

### SessionPersistenceObj

| 参数名 | 必选 | 类型                                 | 说明                                                         |
| :----- | :--- | :----------------------------------- | ------------------------------------------------------------ |
| Key    | 是   | string                               | 在http的reponse设置Cookie的Key的值。字符长度为2~15,以字母开头，以字母或数字结尾,由小写字母、数字或下划线组成, key要求唯一。 |
| Mode   | 否   | int                                  | 默认值为1。<br />0. 表示在缓存中 ( 例如：CDN ) 保留Cookie的内容 <br />1. 表示不在缓存中 ( 例如：CDN ) 保留Cookie的内容, 负载均衡设置的cookie在后端服务可见。<br />2. 表示不在缓存中 ( 例如：CDN ) 保留Cookie的内容, 负载均衡设置的cookie在后端服务是不可见,即透明模式只能看到客户自己设置的Cookie。 |
| Timer  | 否   | object of [Timer](#timerobj) | 设置会话保持的时间参数，单位: 秒。                           |

### TimerObj

| 参数名  | 必选 | 类型 | 说明                                                         |
| :------ | :--- | :--- | ------------------------------------------------------------ |
| MaxIdle | 是   | int  | 默认值为0, 表示不设置，即空闲也会会话保持。<br />单位: 秒。支持范围：0-7200。<br />设置会话保持的最大空闲时长，当连接在该时长内无新的请求，则会话保持结束。 |
| MaxLife | 是   | int  | 默认值为0，表示不设置，即会话会一直保持。<br /> 单位: 秒。支持范围：0-7200。<br />设置会话保持的最大时长，超过该时长则会话保持结束, 且要求maxlife 大于maxidle。 |

### BackendServerObj

| 参数名  | 必选 | 类型   | 说明                               |
| :------ | :--- | :----- | ---------------------------------- |
| IP      | 是   | string | 后端服务器Ip地址（公网下支持域名） |
| Port    | 是   | string | 后端服务器端口                     |
| Weight  | 是   | string | 后端服务器权重，权重范围为1-256    |
| MaxConn | 是   | int    | 后端服务器最大连接数               |

## 3.请求示例

```python
def modify_strategy(instance_uuid):
    """
    修改（删除、修改、添加）Ha实例的当前监听的策略配置列表
    :param instance_uuid: 实例id
    """
    action = "ModifyLoadBalancerStrategys"
    method = "POST"
    param = {}
    url = get_signature(action, AK, AccessKeySecret, method, HAPROXY_URL, param=param)
    body = {
            "InstanceUuid": instance_uuid,
            # "HttpListeners": [],
            "HttpListeners": [
                {
                    "ServerTimeoutUnit": "ms",
                    "ServerTimeout": "1000",
                    "StickySession": "on",
                    "AclWhiteList": [
                        "192.168.1.2"
                    ],
                    "SessionPersistence": {
                        "Key": "test123",
                        "Mode": 2,
                        "Timer": {
                            "MaxIdle": 3333,
                            "MaxLife": 3444
                        }
                    },
                    "CertificateIds": [
                        {
                            "CertificateId": "******",
                            "CertificateName": "******"
                        }
                    ],
                    "ListenerMode": "http",
                    "MaxConn": 100000,
                    "ConnectTimeoutUnit": "ms",
                    "Scheduler": "roundrobin",
                    "BackendServer": [
                        {
                            "IP": "66.66.0.8",
                            "Port": 22222,
                            "Weight": "1",
                            "MaxConn": 2222
                        }
                    ],
                    "ConnectTimeout": "1000",
                    "ClientTimeout": "1000",
                    "ListenerName": "http-test",
                    "ClientTimeoutUnit": "ms",
                    "ListenerPort": 23425
                }
            ],
             "TcpListeners": [
               {
                    "EnableSourceIp":"on",
                    "EnableRepeaterMode":"on",
                    "ServerTimeoutUnit": "ms",
                    "AclWhiteList": [],
                    "ListenerMode": "tcp",
                    "ListenerName": "tcp-test",
                    "Scheduler": "leastconn",
                    "MaxConn": 2323,
                    "ClientTimeoutUnit": "ms",
                    "ListenerPort": 2342,
                    "ServerTimeout": "10000",
                    "ConnectTimeoutUnit": "s",
                    "BackendServer": [
                         {
                             "IP": "66.66.0.8",
                             "MaxConn": 2000,
                             "Port": 2342,
                             "Weight": "1"
                         }
                     ],
                     "ConnectTimeout": "22",
                     "ClientTimeout": "10000",
                }
             ]
    }
    res = requests.post(url, json=body)
    result = json.loads(res.content)
```

## 4.返回参数

| 参数名  | 必选 | 类型   | 说明     |
| :------ | :--- | :----- | :------- |
| Message | 是   | string | 信息描述 |
| Code    | 是   | string | 状态码   |
| Data    | 是   | dict   | 数据     |
| TaskId  | 是   | string | 任务     |

## 5.返回示例

```python
{
    "Code": "Success",
    "Data": {},
    "Message": "Success.",
    "TaskId": "******"
}
```

