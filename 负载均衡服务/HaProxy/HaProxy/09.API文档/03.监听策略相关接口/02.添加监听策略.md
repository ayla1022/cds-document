---
title: 添加监听策略   
date: 2022-07-25 18:45:00
permalink: /pages/1233060/
article: true
---


## 1.接口描述

**Action**： AddLoadBalancerStrategys

**描述**： 增加（不覆盖）Ha实例的当前监听的策略配置列表

**请求地址**： cdsapi.capitalonline.net/lb

**请求方法**： POST

## 2.请求参数
| 参数名        | 必选 | 类型                                       | 说明                  |
| :------------ | :--- | :----------------------------------------- | --------------------- |
| InstanceUuid  | 是   | string                                     | 要修改的实例编号      |
| HttpListeners | 是   | list of [HttpListeners](#httplistenersobj) | http 监听策略配置列表 |
| TcpListeners  | 否   | list of [TcpListeners](#tcplistenersobj)   | tcp 的监听策略列表    |

### HttpListenersObj

| 参数名             | 必选 | 类型                                                   | 说明                                                         |
| :----------------- | :--- | :----------------------------------------------------- | ------------------------------------------------------------ |
| AclWhiteList       | 否   | list                                                   | 设置白名单 例如【"129.12.12.1"，"192.168.1.1/20"】           |
| BackendServer      | 是   | list of [BackendServer](#backendserverobj)             | 后端服务器配置                                               |
| CertificateIds     | 否   | list of [CertificateIdsObj](#certificateidsobj)        | http 监听可以绑定证书，不绑定传空列表                        |
| ClientTimeout      | 是   | string                                                 | 设置客户端连接超时的时间                                     |
| ClientTimeoutUnit  | 是   | string                                                 | 设置客户端连接超时的时间单位【"ms","s"】                     |
| ConnectTimeout     | 是   | string                                                 | 设置请求连接超时时间                                         |
| ConnectTimeoutUnit | 是   | string                                                 | 设置请求连接超时的时间单位【"ms","s"】                       |
| ListenerMode       | 是   | string                                                 | 监听模式                                                     |
| ListenerName       | 是   | string                                                 | 监听策略的名称。<br>字符长度为1~15,以字母开头，以字母或数字结尾,由小写字母、数字或下划线组成, 名字要求唯一。 |
| ListenerPort       | 是   | int                                                    | 策略监听端口。<br>取值范围1-65535，其中22、1080、9100、9101端口不在取值范围已被禁用。 |
| MaxConn            | 是   | int                                                    | 代理端的最大连接数                                           |
| Option             | 否   | object of [OptionObj](#optionobj)                      | 高级配置                                                     |
| Scheduler          | 是   | string                                                 | 调度算法【"roundrobin", "leastconn", "static-rr", "source"】 |
| ServerTimeout      | 是   | string                                                 | 设置服务端超时时间                                           |
| ServerTimeoutUnit  | 是   | string                                                 | 设置服务端超时时间单位 【"ms","s"】                          |
| SessionPersistence | 否   | object of [SessionPersistence](#sessionpersistenceobj) | 设置会话保持功能                                             |
| StickySession      | 是   | string                                                 | 是否开启长连接（Keep Alive）  【"on","off"】                 |

### TcpListenersObj

| 参数名             | 必选 | 类型                                       | 说明                                                         |
| :----------------- | :--- | :----------------------------------------- | ------------------------------------------------------------ |
| AclWhiteList       | 否   | list                                       | 设置白名单 例如【"129.12.12.1"，"192.168.1.1/20"】           |
| BackendServer      | 是   | list of [BackendServer](#backendserverobj) | 后端服务器配置                                               |
| ClientTimeout      | 是   | string                                        | 设置客户端连接超时的时间                                     |
| ClientTimeoutUnit  | 是   | string                                     | 设置客户端连接超时的时间单位【"ms","s"】                     |
| ConnectTimeout     | 是   | string                                        | 设置请求连接超时时间                                         |
| ConnectTimeoutUnit | 是   | string                                     | 设置请求连接超时的时间单位【"ms","s"】                       |
| EnableSourceIp     | 否   | string                                     | 设置获取源IP。取值范围【"on","off"】，默认为off              |
| EnableRepeaterMode | 否   | string                                     | 设置当前Haproxy为中继默认且支持源IP透传。取值范围 【"on","off"】，默认为off，注意：如果设置了EnableRepeaterMode为on，则EnableSourceIp参数也必须为on |
| ListenerMode       | 是   | string                                     | 监听模式                                                     |
| ListenerName       | 是   | string                                     | 监听策略的名称。<br>字符长度为1~15,以字母开头，以字母或数字结尾,由小写字母、数字或下划线组成, 名字要求唯一。 |
| ListenerPort       | 是   | int                                        | 策略监听端口。<br>取值范围1-65535，其中22、1080、9100、9101端口不在取值范围已被禁用。 |
| MaxConn            | 是   | int                                        | 代理端的最大连接数                                           |
| Scheduler          | 是   | string                                     | 调度算法【"roundrobin", "leastconn", "static-rr", "source"】 |
| ServerTimeout      | 是   | string                                        | 设置服务端超时时间                                           |
| ServerTimeoutUnit  | 是   | string                                     | 设置服务端超时时间单位 【"ms","s"】                          |

### CertificateIdsObj

| 参数名          | 必选 | 类型   | 说明     |
| :-------------- | :--- | :----- | -------- |
| CertificateId   | 否   | string | 证书编号 |
| CertificateName | 否   | string | 证书名称 |

### SessionPersistenceObj

| 参数名 | 必选 | 类型                         | 说明                                                         |
| ------ | ---- | ---------------------------- | ------------------------------------------------------------ |
| Key    | 是   | string                       | 在http的reponse设置Cookie的Key的值。字符长度为2~15,以字母开头，以字母或数字结尾,由小写字母、数字或下划线组成, key要求唯一。 |
| Mode   | 否   | int                          | 默认值为1。 0. 表示在缓存中 ( 例如：CDN ) 保留Cookie的内容 1. 表示不在缓存中 ( 例如：CDN ) 保留Cookie的内容, 负载均衡设置的cookie在后端服务可见。 2. 表示不在缓存中 ( 例如：CDN ) 保留Cookie的内容, 负载均衡设置的cookie在后端服务是不可见,即透明模式只能看到客户自己设置的Cookie。 |
| Timer  | 否   | object of [Timer](#timerobj) | 设置会话保持的时间参数，单位: 秒。                           |

### TimerObj

| 参数名  | 必选 | 类型 | 说明                                                         |
| ------- | ---- | ---- | ------------------------------------------------------------ |
| MaxIdle | 是   | int  | 默认值为0, 表示不设置，即空闲也会会话保持。 单位: 秒。支持范围：0-7200。 设置会话保持的最大空闲时长，当连接在该时长内无新的请求，则会话保持结束。 |
| MaxLife | 是   | int  | 默认值为0，表示不设置，即会话会一直保持。 单位: 秒。支持范围：0-7200。 设置会话保持的最大时长，超过该时长则会话保持结束, 且要求maxlife 大于maxidle。 |

### BackendServerObj

| 参数名  | 必选 | 类型   | 说明                               |
| :------ | :--- | :----- | ---------------------------------- |
| IP      | 是   | string | 后端服务器Ip地址（公网下支持域名） |
| Port    | 是   | int    | 后端服务器端口                     |
| Weight  | 是   | string | 后端服务器权重，权重范围为1-256    |
| MaxConn | 是   | int    | 后端服务器最大连接数               |

### OptionObj

| 参数名  | 必选 | 类型                             | 说明             |
| ------- | ---- | -------------------------------- | ---------------- |
| Httpchk | 否   | object of [Httpchk](#httpchkobj) | HTTP开启健康检查 |

### HttpchkObj

| 参数名 | 必选 | 类型   | 说明                                               |
| ------ | ---- | ------ | -------------------------------------------------- |
| Method | 是   | string | 默认值为："GET" 参数范围：["GET","HEAD","OPTIONS"] |
| Uri    | 是   | string | 健康检查uri                                        |

## 3.请求示例

```python
def add_modify_strategy(instance_uuid):
    """
    增量添加策略
    @param instance_uuid:
    @return:
    """
    action = "AddLoadBalancerStrategys"
    method = "POST"
    param = {}
    url = get_signature(action, AK, AccessKeySecret, method, HAPROXY_URL, param=param)
    body = {
        "InstanceUuid": instance_uuid,
        "HttpListeners": [
            {
                "ServerTimeoutUnit": "ms",
                "ServerTimeout": "1002",
                "StickySession": "on",
                "AclWhiteList": [
                    "192.168.1.2"
                ],
                "Option": {
                    "Httpchk": {
                        'Method': "GET",
                        "Uri": '/index.htm'
                    }
                },
                "SessionPersistence": {
                    "Key": "test123",
                    "Mode": 2,
                    "Timer": {
                        "MaxIdle": 3333,
                        "MaxLife": 3444
                    }
                },
                "CertificateIds": [
                    {
                        "CertificateId": "e414686d-4cb2-4bfd-8bae-061703c56781",
                        "CertificateName": "证书测试aa0427"
                    }
                ],
                "ListenerMode": "http",
                "MaxConn": 100000,
                "ConnectTimeoutUnit": "ms",
                "Scheduler": "roundrobin",
                "BackendServer": [
                    {
                        "IP": "88.88.0.9",
                        "Port": 22221,
                        "Weight": "29",
                        "MaxConn": 2222
                    }

                ],
                "ConnectTimeout": "1000",
                "ClientTimeout": "1000",
                "ListenerName": "http343",
                "ClientTimeoutUnit": "ms",
                "ListenerPort": 2345
            }
        ],
    }
    res = requests.post(url, json=body)
    result = json.loads(res.content)
    result = json.dumps(result)
    print(result)
```

## 4.返回参数

| 参数名  | 必选 | 类型   | 说明     |
| :------ | :--- | :----- | :------- |
| Message | 是   | string | 信息描述 |
| Code    | 是   | string | 状态码   |
| Data    | 是   | dict   | 数据     |
| TaskId  | 是   | string | 任务     |

## 5.返回示例

```json
{
    "Code": "Success",
    "Data": {},
    "Message": "The Base configuration will be enabled.The policy modification task is successfully delivered. Wait until the task is executed.",
    "TaskId": "******"
}
```

