---
title: 查询负载均衡指标监控  
date: 2021-12-29 16:01:00
permalink: /pages/1233045/
article: true
---

## 1.接口描述

**Action**: DescribeLBInstancePerformance

**描述**: 获取负载均衡指标的监控数据

**请求地址**: http://cdsapi.capitalonline.net/paas/monitor

**请求方法**： POST

## 2.请求参数

| 参数名       | 必选 | 类型   | 说明                 |
| :----------- | :--- | :----- | :------------------- |
| InstanceUuid | 是   | string | 实例编号             |
| MetricKey    | 是   | string | 可选指标参数(见下表) |
| StartTime    | 是   | string | 开始时间             |
| EndTime      | 是   | string | 结束时间             |

### 性能参数表：

| API参数名     | 类别      | 类型  | 单位   | 含义                   |
| :------------ | :-------- | :---- | :----- | :--------------------- |
| ha_cpu_usage  | resources | gauge | 百分比 | cpu使用率              |
| ha_mem_usage  | resources | gauge | 百分比 | 内存使用率             |
| ha_outpackage | resources | gauge | 个/s   | 负载均衡实例每秒出包量 |
| ha_inpackage  | resources | gauge | 个/s   | 负载均衡实例每秒入包量 |
| ha_outflow    | resources | gauge | MB/s   | 负载均衡实例每秒出流量 |
| ha_inflow     | resources | gauge | MB/s   | 负载均衡实例每秒入流量 |

### 时间粒度：

监控粒度自适应方法如下：

| 时间跨度   | 监控粒度 | 自适应说明                                        | 保留时长 |
| :--------- | :------- | :------------------------------------------------ | :------- |
| (0h, 4h]   | 30s      | 时间跨度在4小时内，监控粒度为5秒                  | 1天      |
| (4h, 2d]   | 1min     | 时间跨度超过4小时，但在2天内，监控粒度调整为1分钟 | 15天     |
| (2d, 10d]  | 5min     | 时间跨度超过2天，但在10天内，监控粒度调整为5分钟  | 31天     |
| (10d, 30d] | 1h       | 时间跨度超过10天，但在30天内，监控粒度调整为1小时 | 62天     |

## 3.请求示例

```python
def get_haproxy_monitor(instance_uuid):
    """
    获取haproxy监控
    """
    action = "DescribeLBInstancePerformance"
    method = "POST"
    url = get_signature(action, AK, AccessKeySecret, method, MONITOR_URL)
    body = {
        "InstanceUuid": instance_uuid,
        "MetricKey": "ha_mem_usage",
        "StartTime": "2021-10-21 13:25:00",
        "EndTime": "2021-10-21 13:28:00"
    }
    res = requests.post(url, json=body)
    result = json.loads(res.content)
    result = json.dumps(result)
    print(result)
```

## 4.返回参数

| 参数名  | 类型                              | 说明                                                   |
| :------ | :-------------------------------- | :----------------------------------------------------- |
| Code    | string                            | 状态码                                                 |
| Data    | [MonitorDataObj](#MonitorDataObj) | 负载均衡监控数据集合以及监控参数                       |
| Message | string                            | 返回调用接口状态信息和code相对应，比如：Success, Error |
| TaskId  | string                            | 任务Id                                                 |

### MonitorDataObj

| 参数名       | 类型                                  | 说明                                             |
| :----------- | :------------------------------------ | :----------------------------------------------- |
| DataPoints   | list of [DataPointObj](#DataPointObj) | 监控数据集合                                     |
| EndTime      | string                                | 结束时间                                         |
| InstanceUuid | str                                   | 实例编号                                         |
| MetricKey    | string                                | 性能指标参数                                     |
| Period       | int                                   | 监控粒度（根据时间跨度自适应监控粒度，单位为秒） |
| ProductType  | str                                   | 产品类型                                         |
| StartTime    | string                                | 开始时间                                         |

### DataPointObj

| 参数名      | 类型                          | 说明                                                    |
| :---------- | :---------------------------- | :------------------------------------------------------ |
| MetricName  | string                        | 性能指标名称                                            |
| MetricType  | string                        | 指标类型（gauge，counter）                              |
| MonitorType | list                          | 监控类型（resources，engine, engine_extension, deploy） |
| Unit        | string                        | 单位                                                    |
| Values      | list of [ValueObj](#ValueObj) | 监控数据列表                                            |

### ValueObj

| 参数名   | 类型   | 说明       |
| :------- | :----- | :--------- |
| DateTime | string | 监控时间点 |
| Value    | float  | 监控数值   |

## 5.返回示例

```python
{
    "Code": "Success",
    "Data": {
        "DataPoints": [{
            "MetricName": "lb_current_memory",
            "MetricType": "gauge",
            "MonitorType": "mem_usage",
            "Unit": "%",
            "Values": [{
                "DateTime": "2021-10-21 13:25:08",
                "Value": 9.29
            }, {
                "DateTime": "2021-10-21 13:25:38",
                "Value": 9.29
            }, {
                "DateTime": "2021-10-21 13:26:08",
                "Value": 9.29
            }, {
                "DateTime": "2021-10-21 13:26:38",
                "Value": 9.29
            }, {
                "DateTime": "2021-10-21 13:27:08",
                "Value": 9.3
            }, {
                "DateTime": "2021-10-21 13:27:38",
                "Value": 9.32
            }]
        }],
        "EndTime": "2021-10-21 13:28:00",
        "InstanceUuid": "********************",
        "MetricKey": "ha_mem_usage",
        "Period": 30,
        "ProductType": "haproxy",
        "StartTime": "2021-10-21 13:25:00"
    },
    "Message": "success",
    "TaskId": ""
}
```

