---
title: 配置获取源IP与源IP多层透传    
date: 2021-11-24 15:25:01
permalink: /pages/1233027/
article: true
---

## 前置条件

您已创建负载均衡监听策略，且负载均衡实例状态为运行中，创建负载均衡监听策略步骤详情参见 [创建负载均衡监听策略](../04.操作指南/01.负载均衡监听策略/00.创建负载均衡监听策略.md)。

## 背景信息

负载均衡 HaProxy 分为单层代理和多层代理，单层 HaProxy 代理，只需开启 **获取源IP** 即可。多层 HaProxy 代理，首层代理（即客户端直连代理）需开启 **获取源IP**，非首层代理需要同时开启 **获取源IP** 和 **源IP多层透传**。且后端服务器需支持 **代理协议（Proxy protocol）**。

## 操作步骤

### HTTP 获取源IP

1. 进入策略配置详情页，协议类型选择 HTTP ，HTTP 协议类型的监听策略默认已开启 **获取源IP**，其他配置项说明详情参见 [策略配置](../04.操作指南/01.负载均衡监听策略/00.创建负载均衡监听策略.md)。

2. 以 Nginx 为例，修改 Nginx 配置文件，`/etc/nginx`目录下`nginx.conf`。部署 Nginx 介绍详情参见 [Ubuntu下部署 Nginx](../03.快速入门/01.Ubuntu下部署Nginx.md)。

   ```
   http{
   	set_real_ip_from IP网段;
   	real_ip_header X-Forwarded-For;
   	log_format http '$http_x_forwarded_for';
    	access_log /var/log/nginx/access.log http;
   }
   ```

   > **说明**：IP 网段为 HaProxy 所在虚拟数据中心私网网段。

3. 按“Esc”退出编辑模式，输入`:wq`保存此次编辑内容并关闭文件。

4. 重启 Nginx 服务以使配置文件生效。

   ```
   /etc/init.d/nginx restart
   ```

5. 通过一台有公网的云服务器访问负载均衡 HaProxy 实例公网 IP，以 http 为例。

   ```
   curl http://${HaProxy IP地址}:${端口}
   ```

6. 进入后端服务器，查看`cat /var/log/nginx`目录下`access.log`，当返回内容为连接 HaProxy 的客户端 IP 时，即证明 HTTP 获取源 IP 成功。

   ```
   tail -f  /var/log/nginx/access.log
   ```

   ![HTTP获取源IP](../pic/practice1.png)

### TCP 获取源IP

1. 进入策略配置详情页，协议类型选择 TCP ，开启 **获取源IP**，其他配置项说明详情参见 [策略配置](../04.操作指南/01.负载均衡监听策略/00.创建负载均衡监听策略.md)。

2. 以 Nginx 为例，修改 Nginx 配置文件，`/etc/nginx`目录下`nginx.conf`。部署 Nginx 介绍详情参见 [Ubuntu下部署 Nginx](../03.快速入门/01.Ubuntu下部署Nginx.md)。

   ```
   http{
   	server{
   		server_name localhost;
   		listen 80 proxy_protocol;（标明使用proxy协议）
   		location / {
   			proxy_set_header X-Real-IP $proxy_protocol_addr;(将请求头中的X-Real-IP修改为真实来源IP)
   		}
   	log_format tcp '$proxy_protocol_addr';
   	access_log /var/log/nginx/access.log tcp;
   	}
   }
   ```

3. 按“Esc”退出编辑模式，输入`:wq`保存此次编辑内容并关闭文件。

4. 重启 Nginx 服务以使配置文件生效。

   ```
   /etc/init.d/nginx restart
   ```

5. 通过一台有公网的云服务器访问负载均衡 HaProxy 实例公网 IP，以 http 为例。

   ```
   curl http://${HaProxy IP地址}:${端口}
   ```

6. 进入后端服务器，查看`cat /var/log/nginx`目录下`access.log`，当返回内容为连接 HaProxy 的客户端 IP 时，即证明 TCP 获取源 IP 成功。

   ```
   tail -f /var/log/nginx/access.log
   ```

   ![HTTP获取源IP](../pic/practice1.png)

### TCP 源IP多层透传

1. 进入二层负载均衡 HaProxy 实例策略配置详情页，协议类型选择 TCP ，开启 **获取源IP** 与 **源IP多层透传**，其他配置项说明详情参见 [策略配置](../04.操作指南/01.负载均衡监听策略/00.创建负载均衡监听策略.md)。

2. 进入首层负载均衡 HaProxy 实例策略配置详情页，协议类型选择 TCP ，开启 **获取源IP**，在后端服务器设置中添加二层负载均衡 HaProxy 服务器。其他配置项说明详情参见 [策略配置](../04.操作指南/01.负载均衡监听策略/00.创建负载均衡监听策略.md)。

3. 以 Nginx 为例，修改 Nginx 配置文件，开启 **代理协议（Proxy protocol）**。详情参见 [TCP 获取源 IP](#TCP 获取源IP)。

4. 通过一台有公网的云服务器访问首层负载均衡 HaProxy 实例公网 IP。

   ```
   curl http://${HaProxy IP地址}:${端口}
   ```

5. 进入后端服务器，查看`cat /var/log/nginx`目录下`access.log`，当返回内容为连接 HaProxy 的客户端 IP 时，即证明 TCP 源IP多层透传成功。

   ```
   tail -f /var/log/nginx/access.log
   ```

   ![HTTP获取源IP](../pic/practice1.png)
